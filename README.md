# ğŸ€ Dulit - ì»¤í”Œ ë°ì´íŠ¸ ê´€ë¦¬ ì•± (Android)

<div align="center">

![App Icon](./readme_source/app_icon.png)

**Clean Architecture ê¸°ë°˜ Android Native í”„ë¡œì íŠ¸**

[![GitHub](https://img.shields.io/badge/GitHub-pyowonsik-181717?style=flat-square&logo=github)](https://github.com/pyowonsik/Dulit-android)
[![Backend](https://img.shields.io/badge/Backend-Dulit--server-3DDC84?style=flat-square&logo=nestjs)](https://github.com/pyowonsik/Dulit-server)

**ê°œë°œ ê¸°ê°„**: 2025.01 ~ ì§„í–‰ì¤‘

</div>

---

## ğŸ“‘ ëª©ì°¨

- [ğŸ“± ìŠ¤í¬ë¦°ìƒ·](#-ìŠ¤í¬ë¦°ìƒ·)
- [ğŸ›  ê¸°ìˆ  ìŠ¤íƒ](#-ê¸°ìˆ -ìŠ¤íƒ)
- [ğŸ’¡ í”„ë¡œì íŠ¸ ì†Œê°œ](#-í”„ë¡œì íŠ¸-ì†Œê°œ)
- [ğŸ—ï¸ ì•„í‚¤í…ì²˜](#ï¸-ì•„í‚¤í…ì²˜)
- [ğŸ”¥ ì£¼ìš” ê¸°ëŠ¥ & êµ¬í˜„ ë‚´ìš©](#-ì£¼ìš”-ê¸°ëŠ¥--êµ¬í˜„-ë‚´ìš©)
- [ğŸ” ë¦¬ë·° & íšŒê³ ](#-ë¦¬ë·°--íšŒê³ )
- [âš ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#ï¸-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ğŸ“± ìŠ¤í¬ë¦°ìƒ·

<p align="center">
  <img src="./readme_source/screenshot_1.png" width="200">
  <img src="./readme_source/screenshot_2.png" width="200">
  <img src="./readme_source/screenshot_3.png" width="200">
</p>

<p align="center">
  <img src="./readme_source/screenshot_4.png" width="200">
  <img src="./readme_source/screenshot_5.png" width="200">
  <img src="./readme_source/screenshot_6.png" width="200">
</p>

---

## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ

### Language & Framework

<img src="https://img.shields.io/badge/Kotlin-7F52FF?style=flat-square&logo=kotlin&logoColor=white"> <img src="https://img.shields.io/badge/Jetpack%20Compose-4285F4?style=flat-square&logo=jetpackcompose&logoColor=white"> <img src="https://img.shields.io/badge/Android-3DDC84?style=flat-square&logo=android&logoColor=white">

### Architecture & DI

<img src="https://img.shields.io/badge/Clean%20Architecture-6DB33F?style=flat-square"> <img src="https://img.shields.io/badge/MVVM-4285F4?style=flat-square"> <img src="https://img.shields.io/badge/Hilt-FF6F00?style=flat-square&logo=dagger&logoColor=white">

### Network & Data

<img src="https://img.shields.io/badge/Retrofit-48B983?style=flat-square"> <img src="https://img.shields.io/badge/OkHttp-3E4348?style=flat-square"> <img src="https://img.shields.io/badge/Socket.IO-010101?style=flat-square&logo=socketdotio&logoColor=white"> <img src="https://img.shields.io/badge/Room-4285F4?style=flat-square&logo=android&logoColor=white">

### Async & State

<img src="https://img.shields.io/badge/Coroutine-7F52FF?style=flat-square&logo=kotlin&logoColor=white"> <img src="https://img.shields.io/badge/Flow-7F52FF?style=flat-square&logo=kotlin&logoColor=white"> <img src="https://img.shields.io/badge/StateFlow-7F52FF?style=flat-square&logo=kotlin&logoColor=white">

### Security & Auth

<img src="https://img.shields.io/badge/EncryptedSharedPreferences-4285F4?style=flat-square"> <img src="https://img.shields.io/badge/JWT-000000?style=flat-square&logo=jsonwebtokens&logoColor=white"> <img src="https://img.shields.io/badge/Kakao%20Login-FFCD00?style=flat-square&logo=kakao&logoColor=black">

### UI & Libraries

<img src="https://img.shields.io/badge/Material3-757575?style=flat-square&logo=materialdesign&logoColor=white"> <img src="https://img.shields.io/badge/Coil-2E7D32?style=flat-square"> <img src="https://img.shields.io/badge/Calendar%20Compose-4285F4?style=flat-square">

---

## ğŸ’¡ í”„ë¡œì íŠ¸ ì†Œê°œ

### ê°œìš”

**Dulit**ì€ ì»¤í”Œì´ í•¨ê»˜ ê¸°ë…ì¼, ë°ì´íŠ¸ ê³„íš, ì¶”ì–µì„ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” **Android Native ì•±**ì…ë‹ˆë‹¤.

ë‹¨ìˆœí•œ CRUDë¥¼ ë„˜ì–´, **ì‹¤ì‹œê°„ í†µì‹ **, **ë³µì¡í•œ ì¸ì¦ ë¡œì§**, **ë³´ì•ˆ í† í° ê´€ë¦¬** ë“± **ì‹¤ë¬´ ìˆ˜ì¤€ì˜ ê¸°ìˆ  ìŠ¤íƒ**ì„ ì ìš©í•œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

### ê¸°ìˆ ì  ë„ì „ ê³¼ì œ

ì´ í”„ë¡œì íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì€ **ê¸°ìˆ ì  ë‚œì´ë„**ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤:

#### 1ï¸âƒ£ Clean Architecture êµ¬í˜„

- **Data-Domain-Presentation** 3-Layer ì™„ë²½ ë¶„ë¦¬
- **ì˜ì¡´ì„± ì—­ì „ ì›ì¹™** (Repository Interface)
- **ë‹¨ì¼ ì±…ì„ ì›ì¹™** (UseCase ë‹¨ìœ„ ë¶„ë¦¬)

#### 2ï¸âƒ£ ì‹¤ì‹œê°„ í†µì‹  (Socket.IO)

- **ì»¤í”Œ ë§¤ì¹­ ì•Œë¦¼** (ì–‘ë°©í–¥ ì‹¤ì‹œê°„ ì—°ê²°)
- **ì‹¤ì‹œê°„ ì±„íŒ…** (ë©”ì‹œì§€ ì†¡ìˆ˜ì‹ )
- **ìë™ ì¬ì—°ê²°** ë° ì—ëŸ¬ í•¸ë“¤ë§

#### 3ï¸âƒ£ ë³µì¡í•œ ì¸ì¦ ë¡œì§

- **JWT ìë™ ê°±ì‹ ** (TokenAuthenticator)
- **401 ì—ëŸ¬ ìë™ ì²˜ë¦¬** (ë¬´í•œ ë£¨í”„ ë°©ì§€)
- **ì†Œì…œ ë¡œê·¸ì¸** (ì¹´ì¹´ì˜¤ OAuth2)

#### 4ï¸âƒ£ ë³´ì•ˆ

- **EncryptedSharedPreferences** (AES256-GCM)
- **Android Keystore** ê¸°ë°˜ í† í° ì•”í˜¸í™”
- **ì¬ì‹œë„ + Fallback ì „ëµ**

#### 5ï¸âƒ£ í•˜ì´ë¸Œë¦¬ë“œ ë°ì´í„° ì†ŒìŠ¤

- **Remote First**: Retrofit ê¸°ë°˜ ì„œë²„ í†µì‹ 
- **Local Cache**: Room ê¸°ë°˜ ì˜¤í”„ë¼ì¸ ì§€ì›
- **ìë™ ë™ê¸°í™”**

#### 6ï¸âƒ£ í˜„ëŒ€ì  UI

- **Jetpack Compose** ì„ ì–¸í˜• UI
- **StateFlow** ê¸°ë°˜ ìƒíƒœ ê´€ë¦¬
- **Material 3** ë””ìì¸ ì‹œìŠ¤í…œ

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### Clean Architecture (3-Layer)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Presentation Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Screen    â”‚  â”‚  ViewModel   â”‚  â”‚  Compose UI    â”‚ â”‚
â”‚  â”‚  (Compose)  â”‚â”€â”€â”‚  (StateFlow) â”‚â”€â”€â”‚   Component    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   Domain Layer     â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                   â”‚  â”‚   UseCase    â”‚  â”‚ â† Business Logic
                   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
                   â”‚  â”‚  Repository  â”‚  â”‚ â† Interface
                   â”‚  â”‚  (Interface) â”‚  â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Data Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RepositoryImpl   â”‚        â”‚   Data Source       â”‚   â”‚
â”‚  â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  (êµ¬í˜„ì²´)          â”‚        â”‚  â”‚  Remote API  â”‚   â”‚   â”‚
â”‚  â”‚                   â”‚        â”‚  â”‚  (Retrofit)  â”‚   â”‚   â”‚
â”‚  â”‚                   â”‚        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚  â”‚                   â”‚        â”‚  â”‚  Local DB    â”‚   â”‚   â”‚
â”‚  â”‚                   â”‚        â”‚  â”‚  (Room)      â”‚   â”‚   â”‚
â”‚  â”‚                   â”‚        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚  â”‚                   â”‚        â”‚  â”‚  Socket.IO   â”‚   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### íŒ¨í‚¤ì§€ êµ¬ì¡°

```
com.example.dulit/
â”œâ”€â”€ core/                        # ê³µí†µ ëª¨ë“ˆ
â”‚   â”œâ”€â”€ network/                 # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ AuthInterceptor      # JWT í—¤ë” ìë™ ì¶”ê°€
â”‚   â”‚   â”œâ”€â”€ TokenAuthenticator   # 401 ì‹œ í† í° ìë™ ê°±ì‹ 
â”‚   â”‚   â””â”€â”€ LoggingInterceptor   # ë¡œê¹…
â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”œâ”€â”€ TokenStorage         # ì•”í˜¸í™” í† í° ì €ì¥ì†Œ
â”‚   â”‚   â””â”€â”€ database/
â”‚   â”‚       â””â”€â”€ AppDatabase      # Room Database
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ component/           # ì¬ì‚¬ìš© ê°€ëŠ¥í•œ UI
â”‚       â””â”€â”€ theme/               # í…Œë§ˆ ì„¤ì •
â”‚
â”œâ”€â”€ di/                          # Hilt ì˜ì¡´ì„± ì£¼ì…
â”‚   â”œâ”€â”€ NetworkModule
â”‚   â”œâ”€â”€ DatabaseModule
â”‚   â””â”€â”€ RepositoryModule
â”‚
â”œâ”€â”€ feature/                     # ê¸°ëŠ¥ë³„ ëª¨ë“ˆ
â”‚   â”œâ”€â”€ auth/                    # ğŸ” ì¸ì¦
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/             # AuthApi
â”‚   â”‚   â”‚   â”œâ”€â”€ model/           # DTO
â”‚   â”‚   â”‚   â””â”€â”€ repository/      # RepositoryImpl
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ model/           # Domain Model
â”‚   â”‚   â”‚   â”œâ”€â”€ repository/      # Repository Interface
â”‚   â”‚   â”‚   â””â”€â”€ usecase/         # UseCase
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚       â”œâ”€â”€ LoginScreen
â”‚   â”‚       â””â”€â”€ LoginViewModel
â”‚   â”‚
â”‚   â”œâ”€â”€ couple/                  # ğŸ’‘ ì»¤í”Œ ì—°ê²°
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ remote/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ CoupleMatchingSocketClient  # Socket.IO
â”‚   â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚
â”‚   â”œâ”€â”€ home/                    # ğŸ  í™ˆ (ê¸°ë…ì¼, ì•½ì†)
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â”œâ”€â”€ local/           # Room Entity, DAO
â”‚   â”‚   â”‚   â”œâ”€â”€ remote/          # API, DTO
â”‚   â”‚   â”‚   â””â”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â””â”€â”€ presentation/
â”‚   â”‚
â”‚   â”œâ”€â”€ chat/                    # ğŸ’¬ ì±„íŒ…
â”‚   â”œâ”€â”€ calendar/                # ğŸ“… ìº˜ë¦°ë”
â”‚   â”œâ”€â”€ post/                    # ğŸ“ ê²Œì‹œê¸€
â”‚   â””â”€â”€ user/                    # ğŸ‘¤ ì‚¬ìš©ì
â”‚
â””â”€â”€ navigation/                  # ë„¤ë¹„ê²Œì´ì…˜
    â”œâ”€â”€ DulitNavigation
    â””â”€â”€ Route
```

### ë°ì´í„° í”Œë¡œìš° ì˜ˆì‹œ

```kotlin
// 1ï¸âƒ£ Presentation â†’ UseCase í˜¸ì¶œ
// HomeScreen.kt
LaunchedEffect(Unit) {
    anniversaryViewModel.getAnniversaries()
}

// 2ï¸âƒ£ ViewModel â†’ UseCase ì‹¤í–‰
// AnniversaryViewModel.kt
fun getAnniversaries() = viewModelScope.launch {
    val result = getAnniversariesUseCase()
    _anniversaries.value = result.getOrElse { emptyList() }
}

// 3ï¸âƒ£ UseCase â†’ Repository í˜¸ì¶œ
// GetAnniversariesUseCase.kt
suspend operator fun invoke(): Result<List<Anniversary>> {
    return anniversaryRepository.findAllAnniversaries()
}

// 4ï¸âƒ£ Repository â†’ Remote/Local ë°ì´í„° ì†ŒìŠ¤
// AnniversaryRepositoryImpl.kt
override suspend fun findAllAnniversaries(): Result<List<Anniversary>> {
    return runCatching {
        val response = anniversaryApi.findAllAnniversaries()
        response.body()!!.map { it.toDomain() }
    }
}
```

---

## ğŸ”¥ ì£¼ìš” ê¸°ëŠ¥ & êµ¬í˜„ ë‚´ìš©

### 1. ğŸ” JWT ìë™ ê°±ì‹  (TokenAuthenticator)

#### ë¬¸ì œ ìƒí™©

AccessTokenì´ ë§Œë£Œë˜ë©´ **ëª¨ë“  API ìš”ì²­ì´ 401 ì—ëŸ¬**ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì‚¬ìš©ìì—ê²Œ **ë¡œê·¸ì¸ì„ ë‹¤ì‹œ ìš”êµ¬í•˜ëŠ” ê²ƒì€ ë‚˜ìœ UX**ì…ë‹ˆë‹¤.

#### í•´ê²°: OkHttp Authenticator

```kotlin
// core/network/TokenAuthenticator.kt
class TokenAuthenticator @Inject constructor(
    private val tokenStorage: TokenStorage,
    private val rotateAccessTokenUseCase: Lazy<RotateAccessTokenUseCase>
) : Authenticator {

    override fun authenticate(route: Route?, response: Response): Request? {
        Log.d("TokenAuthenticator", "401 ì—ëŸ¬ ê°ì§€ - í† í° ê°±ì‹  ì‹œì‘")

        // â­ ì¬ì‹œë„ ë°©ì§€ (ë¬´í•œ ë£¨í”„ ì°¨ë‹¨)
        if (response.request.header("X-Retry-Auth") != null) {
            tokenStorage.clearTokens()
            return null
        }

        val refreshToken = tokenStorage.getRefreshToken() ?: return null

        return runBlocking {
            try {
                val result = rotateAccessTokenUseCase.get().invoke()

                result.fold(
                    onSuccess = { tokens ->
                        tokenStorage.saveAccessToken(tokens.accessToken)

                        // â­ ìƒˆ í† í°ìœ¼ë¡œ ì¬ìš”ì²­
                        response.request.newBuilder()
                            .header("Authorization", "Bearer ${tokens.accessToken}")
                            .header("X-Retry-Auth", "true")
                            .build()
                    },
                    onFailure = {
                        tokenStorage.clearTokens()
                        null
                    }
                )
            } catch (e: Exception) {
                tokenStorage.clearTokens()
                null
            }
        }
    }
}
```

#### OkHttp í´ë¼ì´ì–¸íŠ¸ ë¶„ë¦¬

```kotlin
// di/NetworkModule.kt

// 1ï¸âƒ£ AuthApi ì „ìš© (í† í° ê°±ì‹ ìš© - Authenticator ì œì™¸)
@Provides
@Named("AuthOkHttpClient")
fun provideAuthOkHttpClient(
    loggingInterceptor: LoggingInterceptor
): OkHttpClient {
    return OkHttpClient.Builder()
        .addInterceptor(loggingInterceptor)
        .build()
}

// 2ï¸âƒ£ ì¼ë°˜ API ì „ìš© (Authenticator í¬í•¨)
@Provides
@Named("MainOkHttpClient")
fun provideMainOkHttpClient(
    authInterceptor: AuthInterceptor,
    tokenAuthenticator: TokenAuthenticator,  // â­ ìë™ ê°±ì‹ 
    loggingInterceptor: LoggingInterceptor
): OkHttpClient {
    return OkHttpClient.Builder()
        .addInterceptor(authInterceptor)
        .authenticator(tokenAuthenticator)  // â­ 401 ì‹œ ìë™ ê°±ì‹ 
        .addInterceptor(loggingInterceptor)
        .build()
}
```

#### ë™ì‘ íë¦„

```
[Client]
   â†“ API ìš”ì²­ (AccessToken ë§Œë£Œë¨)
[Server]
   â†“ 401 Unauthorized
[TokenAuthenticator]
   â†“ RefreshTokenìœ¼ë¡œ í† í° ê°±ì‹  API í˜¸ì¶œ
[Server]
   â†“ ìƒˆë¡œìš´ AccessToken ë°œê¸‰
[TokenAuthenticator]
   â†“ ìƒˆ í† í° ì €ì¥ + ì›ë˜ ìš”ì²­ ì¬ì‹œë„
[Server]
   â†“ 200 OK
[Client]
   âœ… ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ íŠ•ê¸°ì§€ ì•ŠìŒ!
```

#### í•µì‹¬ í¬ì¸íŠ¸

âœ… **ë¬´í•œ ë£¨í”„ ë°©ì§€**: `X-Retry-Auth` í—¤ë”ë¡œ ì¬ì‹œë„ 1íšŒ ì œí•œ  
âœ… **OkHttp í´ë¼ì´ì–¸íŠ¸ ë¶„ë¦¬**: í† í° ê°±ì‹  APIëŠ” Authenticator ì œì™¸  
âœ… **Lazy ì£¼ì…**: ìˆœí™˜ ì°¸ì¡° ë°©ì§€ (`Lazy<RotateAccessTokenUseCase>`)  
âœ… **runBlocking ì‚¬ìš©**: AuthenticatorëŠ” Suspend ë¶ˆê°€

---

### 2. ğŸ”’ EncryptedSharedPreferences (ë³´ì•ˆ í† í° ì €ì¥)

#### ì™œ í•„ìš”í•œê°€?

ì¼ë°˜ SharedPreferencesëŠ” **í‰ë¬¸(Plain Text)ìœ¼ë¡œ ì €ì¥**ë˜ì–´ **ë£¨íŒ…ëœ ê¸°ê¸°ì—ì„œ í† í° íƒˆì·¨ ê°€ëŠ¥**í•©ë‹ˆë‹¤.

#### Android Keystore ê¸°ë°˜ ì•”í˜¸í™”

```kotlin
// core/local/TokenStorage.kt
class TokenStorage(private val context: Context) {

    // â­ Android Keystore ê¸°ë°˜ MasterKey
    private val masterKey by lazy {
        MasterKey.Builder(context)
            .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
            .build()
    }

    // â­ ì•”í˜¸í™”ëœ SharedPreferences
    private val sharedPreferences: SharedPreferences by lazy {
        createEncryptedPreferences()
    }

    private fun createEncryptedPreferences(): SharedPreferences {
        return runCatching {
            // 1ì°¨ ì‹œë„
            EncryptedSharedPreferences.create(
                context,
                "token_prefs",
                masterKey,
                EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
                EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
            )
        }.recoverCatching {
            // 2ì°¨ ì‹œë„ (ì†ìƒëœ íŒŒì¼ ì •ë¦¬ í›„ ì¬ì‹œë„)
            deleteCorruptedFiles()
            EncryptedSharedPreferences.create(...)
        }.getOrElse {
            // Fallback: ì¼ë°˜ SharedPreferences
            context.getSharedPreferences("token_prefs_fallback", Context.MODE_PRIVATE)
        }
    }

    fun saveAccessToken(token: String) {
        sharedPreferences.edit()
            .putString("access_token", token)
            .apply()
    }

    fun getAccessToken(): String? {
        return sharedPreferences.getString("access_token", null)
    }
}
```

#### ì•”í˜¸í™” ì „ëµ

| ë‹¨ê³„         | ë™ì‘                            | ê²°ê³¼                             |
| ------------ | ------------------------------- | -------------------------------- |
| **1ì°¨ ì‹œë„** | EncryptedSharedPreferences ìƒì„± | ì„±ê³µ â†’ ì•”í˜¸í™” ì €ì¥ì†Œ ì‚¬ìš©        |
| **2ì°¨ ì‹œë„** | ì†ìƒëœ íŒŒì¼ ì‚­ì œ í›„ ì¬ì‹œë„      | ì„±ê³µ â†’ ì•”í˜¸í™” ì €ì¥ì†Œ ì‚¬ìš©        |
| **Fallback** | ì¼ë°˜ SharedPreferences ì‚¬ìš©     | ì•”í˜¸í™” ì—†ì§€ë§Œ **ì•± í¬ë˜ì‹œ ë°©ì§€** |

#### ë³´ì•ˆ ìˆ˜ì¤€

âœ… **AES256-GCM** ì•”í˜¸í™” (êµ°ì‚¬ ìˆ˜ì¤€)  
âœ… **Android Keystore** ì €ì¥ (í•˜ë“œì›¨ì–´ ë³´ì•ˆ ëª¨ë“ˆ)  
âœ… **ë£¨íŒ… ê¸°ê¸°ì—ì„œë„ ì¼ì • ìˆ˜ì¤€ ë³´í˜¸**  
âœ… **í† í° íƒˆì·¨ ë‚œì´ë„ ê·¹ìƒ**

---

### 3. ğŸ’‘ Socket.IO ì‹¤ì‹œê°„ ì»¤í”Œ ë§¤ì¹­

#### ê¸°ëŠ¥ ì„¤ëª…

1. ì‚¬ìš©ì Aê°€ **ì´ˆëŒ€ ì½”ë“œ ìƒì„±**
2. ì‚¬ìš©ì Bê°€ **ì´ˆëŒ€ ì½”ë“œ ì…ë ¥**
3. ë°±ì—”ë“œì—ì„œ **ì»¤í”Œ ë§¤ì¹­ ì„±ê³µ**
4. **ì–‘ìª½ì— ì‹¤ì‹œê°„ ì•Œë¦¼** (Socket.IO)

#### Socket.IO í´ë¼ì´ì–¸íŠ¸

```kotlin
// feature/couple/data/remote/CoupleMatchingSocketClient.kt
@Singleton
class CoupleMatchingSocketClient @Inject constructor(
    private val tokenStorage: TokenStorage
) {
    private var socket: Socket? = null

    fun connect(userId: String): Flow<MatchingSocketEvent> = callbackFlow {
        try {
            val accessToken = tokenStorage.getAccessToken() ?: ""

            val options = IO.Options().apply {
                query = "userId=$userId&token=Bearer $accessToken"
                transports = arrayOf("polling", "websocket")
                reconnection = true
                reconnectionAttempts = 5
                reconnectionDelay = 2000
                timeout = 20000
                forceNew = true
            }

            socket = IO.socket("$SOCKET_URL/notification", options)

            // ì—°ê²° ì„±ê³µ
            socket?.on(Socket.EVENT_CONNECT) {
                Log.i("CoupleMatchingSocket", "âœ… ì†Œì¼“ ì—°ê²° ì„±ê³µ!")
                trySend(MatchingSocketEvent.Connected)
            }

            // ë§¤ì¹­ ì•Œë¦¼
            socket?.on("matchedNotification") { args ->
                val message = args.getOrNull(0) as? String
                Log.i("CoupleMatchingSocket", "ğŸ“© ë§¤ì¹­ ì•Œë¦¼ ìˆ˜ì‹ : $message")
                trySend(MatchingSocketEvent.Matched(message ?: "ì»¤í”Œ ì—°ê²° ì™„ë£Œ!"))
            }

            socket?.connect()

        } catch (e: Exception) {
            trySend(MatchingSocketEvent.Error(e.message ?: "ì—°ê²° ì‹¤íŒ¨"))
        }

        awaitClose {
            disconnect()
        }
    }

    fun disconnect() {
        socket?.disconnect()
        socket?.off()
        socket = null
    }
}

sealed class MatchingSocketEvent {
    object Connected : MatchingSocketEvent()
    object Disconnected : MatchingSocketEvent()
    data class Matched(val message: String) : MatchingSocketEvent()
    data class Error(val message: String) : MatchingSocketEvent()
}
```

#### ViewModelì—ì„œ ì‚¬ìš©

```kotlin
// feature/couple/presentation/CoupleMatchingViewModel.kt
@HiltViewModel
class CoupleMatchingViewModel @Inject constructor(
    private val connectMatchingSocketUseCase: ConnectMatchingSocketUseCase
) : ViewModel() {

    private val _matchingState = MutableStateFlow<MatchingState>(MatchingState.Idle)
    val matchingState: StateFlow<MatchingState> = _matchingState

    fun startMatching(userId: String) {
        viewModelScope.launch {
            connectMatchingSocketUseCase(userId).collect { event ->
                when (event) {
                    is MatchingSocketEvent.Connected -> {
                        _matchingState.value = MatchingState.Waiting
                    }
                    is MatchingSocketEvent.Matched -> {
                        _matchingState.value = MatchingState.Success(event.message)
                    }
                    is MatchingSocketEvent.Error -> {
                        _matchingState.value = MatchingState.Error(event.message)
                    }
                    else -> {}
                }
            }
        }
    }
}
```

#### í•µì‹¬ í¬ì¸íŠ¸

âœ… **callbackFlow**: Socket ì´ë²¤íŠ¸ë¥¼ Flowë¡œ ë³€í™˜  
âœ… **awaitClose**: ViewModel ì¢…ë£Œ ì‹œ ìë™ ì†Œì¼“ í•´ì œ  
âœ… **Reconnection ì „ëµ**: ìµœëŒ€ 5íšŒ ì¬ì‹œë„  
âœ… **JWT ì¸ì¦**: Socket ì—°ê²° ì‹œ Query Parameterë¡œ í† í° ì „ë‹¬

---

### 4. ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ… (Socket.IO)

#### ì±„íŒ… ViewModel

```kotlin
// feature/chat/presentation/ChatViewModel.kt
@HiltViewModel
class ChatViewModel @Inject constructor(
    private val tokenStorage: TokenStorage
) : ViewModel() {

    private var socket: Socket? = null

    private val _chatState = MutableStateFlow<ChatState>(ChatState.Idle)
    val chatState: StateFlow<ChatState> = _chatState

    private val _messages = MutableStateFlow<List<ChatMessage>>(emptyList())
    val messages: StateFlow<List<ChatMessage>> = _messages

    fun connectChatSocket() {
        viewModelScope.launch {
            try {
                val accessToken = tokenStorage.getAccessToken() ?: ""

                val options = IO.Options().apply {
                    query = "token=Bearer $accessToken"
                    transports = arrayOf("polling", "websocket")
                    reconnection = true
                }

                socket = IO.socket("$SOCKET_URL/chat", options)

                // ì—°ê²° ì„±ê³µ
                socket?.on(Socket.EVENT_CONNECT) {
                    _chatState.value = ChatState.Connected
                }

                // ë©”ì‹œì§€ ìˆ˜ì‹ 
                socket?.on("sendMessage") { args ->
                    val data = args.getOrNull(0) as? JSONObject
                    // ë©”ì‹œì§€ íŒŒì‹± í›„ _messagesì— ì¶”ê°€
                }

                socket?.connect()

            } catch (e: Exception) {
                _chatState.value = ChatState.Error(e.message ?: "ì—°ê²° ì‹¤íŒ¨")
            }
        }
    }

    fun sendMessage(message: String) {
        try {
            val data = JSONObject().apply {
                put("message", message)
            }
            socket?.emit("sendMessage", data)
        } catch (e: Exception) {
            Log.e("ChatViewModel", "ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨", e)
        }
    }

    override fun onCleared() {
        super.onCleared()
        socket?.disconnect()
        socket?.off()
        socket = null
    }
}
```

#### í•µì‹¬ í¬ì¸íŠ¸

âœ… **ì–‘ë°©í–¥ í†µì‹ **: `emit(sendMessage)` + `on(sendMessage)`  
âœ… **onCleared()**: ViewModel ì¢…ë£Œ ì‹œ ì†Œì¼“ ì •ë¦¬  
âœ… **StateFlow**: UIì— ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸

---

### 5. ğŸ  Room + Retrofit í•˜ì´ë¸Œë¦¬ë“œ ë°ì´í„° ì†ŒìŠ¤

#### Repository íŒ¨í„´

```kotlin
// feature/home/data/repository/AnniversaryRepositoryImpl.kt
class AnniversaryRepositoryImpl @Inject constructor(
    private val anniversaryApi: AnniversaryApi,  // Remote
    private val anniversaryDao: AnniversaryDao   // Local
) : AnniversaryRepository {

    // â­ Remote ìš°ì„  + Local ìºì‹±
    override suspend fun findAllAnniversaries(): Result<List<Anniversary>> {
        return runCatching {
            // 1ï¸âƒ£ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ì¡°íšŒ
            val response = anniversaryApi.findAllAnniversaries()
            val anniversaries = response.body()!!.map { it.toDomain() }

            // 2ï¸âƒ£ ë¡œì»¬ DBì— ìºì‹±
            anniversaryDao.insertAll(anniversaries.map { AnniversaryEntity.fromDomain(it) })

            anniversaries
        }.recoverCatching {
            // 3ï¸âƒ£ ì„œë²„ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ DBì—ì„œ ì¡°íšŒ
            anniversaryDao.findAll().map { it.toDomain() }
        }
    }

    override suspend fun createAnniversary(request: CreateAnniversaryRequest): Result<Anniversary> {
        return runCatching {
            val response = anniversaryApi.createAnniversary(request.toDto())
            val anniversary = response.body()!!.toDomain()

            // ë¡œì»¬ DBì—ë„ ì €ì¥
            anniversaryDao.insert(AnniversaryEntity.fromDomain(anniversary))

            anniversary
        }
    }
}
```

#### Room Entity

```kotlin
// feature/home/data/local/entity/AnniversaryEntity.kt
@Entity(tableName = "anniversaries")
data class AnniversaryEntity(
    @PrimaryKey
    val id: Int,
    val title: String,
    val date: String,
    val createdAt: String,
    val updatedAt: String
) {
    fun toDomain() = Anniversary(
        id = id,
        title = title,
        date = date,
        createdAt = createdAt,
        updatedAt = updatedAt
    )
}
```

#### ë°ì´í„° íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ViewModel (StateFlow)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           UseCase (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Repository (ë°ì´í„° ì¡°ì •ì)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Remote (API)   â”‚  Local (Room)    â”‚   â”‚
â”‚  â”‚  âœ… ìµœì‹  ë°ì´í„°  â”‚  âœ… ì˜¤í”„ë¼ì¸ ì§€ì› â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### í•µì‹¬ í¬ì¸íŠ¸

âœ… **Remote First**: ì„œë²„ ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë¡œì»¬ Fallback  
âœ… **ìë™ ìºì‹±**: API ì‘ë‹µì„ Roomì— ì €ì¥  
âœ… **ì˜¤í”„ë¼ì¸ ì§€ì›**: ë„¤íŠ¸ì›Œí¬ ëŠê²¨ë„ ë¡œì»¬ ë°ì´í„° í‘œì‹œ  
âœ… **Single Source of Truth**: Repositoryê°€ ë°ì´í„° ì¶œì²˜ ë‹¨ì¼í™”

---

### 6. ğŸ¨ Jetpack Compose UI

#### ì„ ì–¸í˜• UI

```kotlin
// feature/home/presentation/HomeScreen.kt
@Composable
fun HomeScreen(
    anniversaryViewModel: AnniversaryViewModel = hiltViewModel()
) {
    val anniversaries by anniversaryViewModel.anniversaries.collectAsState()
    val anniversaryState by anniversaryViewModel.anniversaryState.collectAsState()

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    LaunchedEffect(Unit) {
        anniversaryViewModel.getAnniversaries()
    }

    when (anniversaryState) {
        is AnniversaryState.Loading -> LoadingIndicator()
        is AnniversaryState.Success -> {
            LazyColumn {
                items(anniversaries) { anniversary ->
                    AnniversaryCard(
                        item = anniversary,
                        onEdit = { /* ìˆ˜ì • */ },
                        onDelete = { anniversaryViewModel.deleteAnniversary(it.id) }
                    )
                }
            }
        }
        is AnniversaryState.Error -> ErrorScreen()
    }
}
```

#### ìƒíƒœ ê´€ë¦¬ (StateFlow)

```kotlin
// feature/home/presentation/viewmodel/AnniversaryViewModel.kt
@HiltViewModel
class AnniversaryViewModel @Inject constructor(
    private val getAnniversariesUseCase: GetAnniversariesUseCase,
    private val deleteAnniversaryUseCase: DeleteAnniversaryUseCase
) : ViewModel() {

    private val _anniversaries = MutableStateFlow<List<Anniversary>>(emptyList())
    val anniversaries: StateFlow<List<Anniversary>> = _anniversaries

    private val _anniversaryState = MutableStateFlow<AnniversaryState>(AnniversaryState.Idle)
    val anniversaryState: StateFlow<AnniversaryState> = _anniversaryState

    fun getAnniversaries() = viewModelScope.launch {
        _anniversaryState.value = AnniversaryState.Loading

        val result = getAnniversariesUseCase()

        result.fold(
            onSuccess = { list ->
                _anniversaries.value = list
                _anniversaryState.value = AnniversaryState.Success
            },
            onFailure = { error ->
                _anniversaryState.value = AnniversaryState.Error(error.message ?: "")
            }
        )
    }

    fun deleteAnniversary(id: Int) = viewModelScope.launch {
        deleteAnniversaryUseCase(id)
        getAnniversaries()  // ì‚­ì œ í›„ ì¬ì¡°íšŒ
    }
}

sealed class AnniversaryState {
    object Idle : AnniversaryState()
    object Loading : AnniversaryState()
    object Success : AnniversaryState()
    data class Error(val message: String) : AnniversaryState()
}
```

#### í•µì‹¬ í¬ì¸íŠ¸

âœ… **Recomposition**: State ë³€ê²½ ì‹œ ìë™ UI ì—…ë°ì´íŠ¸  
âœ… **collectAsState()**: Flow â†’ Compose State ë³€í™˜  
âœ… **LaunchedEffect**: Side Effect ì‹¤í–‰  
âœ… **hiltViewModel()**: Hilt DIë¡œ ViewModel ì£¼ì…

---

### 7. ğŸ’‰ Hilt ì˜ì¡´ì„± ì£¼ì…

#### Application ì„¤ì •

```kotlin
@HiltAndroidApp
class DulitApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        KakaoSdk.init(this, getString(R.string.kakao_native_app_key))
    }
}
```

#### Module ì˜ˆì‹œ

```kotlin
// di/NetworkModule.kt
@Module
@InstallIn(SingletonComponent::class)
object NetworkModule {

    @Provides
    @Singleton
    fun provideAuthInterceptor(tokenStorage: TokenStorage): AuthInterceptor {
        return AuthInterceptor(tokenStorage)
    }

    @Provides
    @Singleton
    fun provideTokenAuthenticator(
        tokenStorage: TokenStorage,
        rotateAccessTokenUseCase: Lazy<RotateAccessTokenUseCase>
    ): TokenAuthenticator {
        return TokenAuthenticator(tokenStorage, rotateAccessTokenUseCase)
    }

    @Provides
    @Singleton
    @Named("MainOkHttpClient")
    fun provideMainOkHttpClient(
        authInterceptor: AuthInterceptor,
        tokenAuthenticator: TokenAuthenticator
    ): OkHttpClient {
        return OkHttpClient.Builder()
            .addInterceptor(authInterceptor)
            .authenticator(tokenAuthenticator)
            .build()
    }
}
```

#### ViewModel ì£¼ì…

```kotlin
@HiltViewModel
class LoginViewModel @Inject constructor(
    private val kakaoLoginUseCase: KakaoLoginUseCase,
    val tokenStorage: TokenStorage
) : ViewModel() {
    // ...
}
```

#### í•µì‹¬ í¬ì¸íŠ¸

âœ… **@HiltAndroidApp**: Applicationì— Hilt í™œì„±í™”  
âœ… **@Provides**: ì˜ì¡´ì„± ì œê³µ  
âœ… **@Singleton**: ì‹±ê¸€í†¤ ìŠ¤ì½”í”„  
âœ… **@Named**: ê°™ì€ íƒ€ì… êµ¬ë¶„ (AuthOkHttpClient vs MainOkHttpClient)  
âœ… **Lazy<T>**: ìˆœí™˜ ì°¸ì¡° ë°©ì§€

---

## ğŸ” ë¦¬ë·° & íšŒê³ 

### ë°°ìš´ ì 

#### 1. Clean Architectureì˜ ì§„ì •í•œ ê°€ì¹˜

**"ì²˜ìŒì—ëŠ” ê³¼í•œ ì„¤ê³„ë¼ê³  ìƒê°í–ˆì§€ë§Œ, ê°œë°œì´ ì§„í–‰ë ìˆ˜ë¡ ê·¸ ê°€ì¹˜ë¥¼ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤."**

**ì™œ í•„ìˆ˜ì¸ê°€?**

- **ë ˆì´ì–´ ë¶„ë¦¬**: Data-Domain-Presentationì´ ëª…í™•í•˜ê²Œ ë‚˜ë‰˜ì–´ì•¼ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
- **ì˜ì¡´ì„± ì—­ì „**: Domainì€ Dataë¥¼ ëª¨ë¥´ê³ , Interfaceë§Œ ì•Œì•„ì•¼ í•¨
- **í™•ì¥ì„±**: ìƒˆë¡œìš´ ë°ì´í„° ì†ŒìŠ¤(GraphQL, WebSocket) ì¶”ê°€ ì‹œ Repositoryë§Œ ìˆ˜ì •
- **íŒ€ í˜‘ì—…**: ê° ë ˆì´ì–´ì˜ ì±…ì„ì´ ëª…í™•í•´ì„œ ì½”ë“œ ë¦¬ë·°ê°€ ì‰¬ì›Œì§

**ì‹¤ì œ ê²½í—˜í•œ ì¥ì **

ì˜ˆë¥¼ ë“¤ì–´, Anniversary ê¸°ëŠ¥ì— **ë¡œì»¬ ìºì‹±**ì„ ì¶”ê°€í•  ë•Œ:

- ViewModel, UseCaseëŠ” **ìˆ˜ì • ë¶ˆí•„ìš”**
- Repository êµ¬í˜„ì²´ë§Œ ìˆ˜ì • (Remote + Local ë¡œì§ ì¶”ê°€)
- Domain LayerëŠ” ì—¬ì „íˆ "ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤"ëŠ” ì¶”ìƒì  ê°œë…ë§Œ ì•Œê³  ìˆìŒ

ì´ê²ƒì´ **"ë³€ê²½ì— ë‹«í˜€ìˆê³  í™•ì¥ì— ì—´ë ¤ìˆë‹¤"**ëŠ” OCPì˜ ì‹¤ì²´ì˜€ìŠµë‹ˆë‹¤.

#### 2. Hiltì˜ ê°•ë ¥í•¨

**"ì˜ì¡´ì„± ì£¼ì…ì´ ì´ë ‡ê²Œ í¸í•  ìˆ˜ ìˆë‹¤ë‹ˆ!"**

```kotlin
// âŒ ìˆ˜ë™ DI (ì˜ì¡´ì„± ì§ì ‘ ìƒì„±)
class AnniversaryViewModel(
    private val getAnniversariesUseCase: GetAnniversariesUseCase
) : ViewModel() {
    // ì–´ë””ì„ ê°€ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì„œ ë„˜ê²¨ì¤˜ì•¼ í•¨
}

// âœ… Hilt (ìë™ ì£¼ì…)
@HiltViewModel
class AnniversaryViewModel @Inject constructor(
    private val getAnniversariesUseCase: GetAnniversariesUseCase
) : ViewModel()
// Composableì—ì„œ hiltViewModel()ë¡œ ìë™ ì£¼ì…!
```

**Hiltì˜ í•µì‹¬ ì¥ì **

âœ… **ì»´íŒŒì¼ íƒ€ì„ ì²´í¬**: ì˜ì¡´ì„± ê·¸ë˜í”„ ëˆ„ë½ ì‹œ ë¹Œë“œ ì‹¤íŒ¨  
âœ… **ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ì œê±°**: Moduleë§Œ ì •ì˜í•˜ë©´ ìë™ ì£¼ì…  
âœ… **ìƒëª…ì£¼ê¸° ê´€ë¦¬**: Singleton, ViewModelScoped ë“± ìë™ ê´€ë¦¬  
âœ… **í…ŒìŠ¤íŠ¸ ìš©ì´**: Mock ê°ì²´ ì£¼ì…ì´ ê°„ë‹¨í•¨

#### 3. Jetpack Composeì˜ ì„ ì–¸í˜• UI

**"XMLì„ ë²—ì–´ë‚˜ë‹ˆ UI ê°œë°œì´ ì´ë ‡ê²Œ ì¦ê±°ìš¸ ìˆ˜ ìˆë‹¤ë‹ˆ!"**

**Composeì˜ í•µì‹¬ ê°œë…**

```kotlin
// ì„ ì–¸í˜• UI: ìƒíƒœ(State)ê°€ ë³€ê²½ë˜ë©´ UIê°€ ìë™ ì—…ë°ì´íŠ¸
@Composable
fun AnniversaryList(anniversaries: List<Anniversary>) {
    LazyColumn {
        items(anniversaries) { anniversary ->
            AnniversaryCard(item = anniversary)
        }
    }
}

// StateFlow ë³€ê²½ ì‹œ ìë™ Recomposition
val anniversaries by viewModel.anniversaries.collectAsState()
```

**ë°°ìš´ í•µì‹¬ í¬ì¸íŠ¸**

âœ… **Recomposition ìµœì í™”**: ë³€ê²½ëœ Composableë§Œ ì¬êµ¬ì„±  
âœ… **remember**: ìƒíƒœ ê¸°ì–µ (í™”ë©´ íšŒì „ì—ë„ ìœ ì§€ë˜ì§€ ì•ŠìŒ)  
âœ… **LaunchedEffect**: Coroutine ê¸°ë°˜ Side Effect  
âœ… **collectAsState()**: Flow â†’ State ë³€í™˜  
âœ… **key íŒŒë¼ë¯¸í„°**: LazyColumn ì„±ëŠ¥ ìµœì í™”

#### 4. Socket.IOë¥¼ Kotlin Flowë¡œ í†µí•©í•˜ê¸°

**"ì½œë°± ê¸°ë°˜ Socket.IOë¥¼ Kotlin Coroutineê³¼ í†µí•©í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì–´ë ¤ì› ìŠµë‹ˆë‹¤."**

**ë¬¸ì œì **

Socket.IOëŠ” **JavaScript ìŠ¤íƒ€ì¼ ì½œë°± ê¸°ë°˜**ì¸ë°, AndroidëŠ” **Kotlin Flow ê¸°ë°˜**ì…ë‹ˆë‹¤.

```kotlin
// âŒ ì½œë°± ì§€ì˜¥ì— ë¹ ì§ˆ ë»”í•œ ì½”ë“œ
socket.on("matchedNotification") { args ->
    // ì—¬ê¸°ì„œ ViewModelì— ì–´ë–»ê²Œ ì „ë‹¬í•˜ì§€?
    // StateFlowë¥¼ ì–´ë–»ê²Œ ì—…ë°ì´íŠ¸í•˜ì§€?
}
```

**í•´ê²°: callbackFlow**

```kotlin
// âœ… Socket ì´ë²¤íŠ¸ë¥¼ Flowë¡œ ë³€í™˜
fun connect(): Flow<MatchingSocketEvent> = callbackFlow {
    val socket = IO.socket("http://localhost:3000", options)

    socket.on("matchedNotification") { args ->
        trySend(MatchingSocketEvent.Matched(args[0] as String))
    }

    socket.connect()

    awaitClose {
        socket.disconnect()  // Flow ì¢…ë£Œ ì‹œ ìë™ ì •ë¦¬
    }
}
```

**ë°°ìš´ ì **

âœ… **callbackFlow**: ì½œë°±ì„ Flowë¡œ ë³€í™˜  
âœ… **trySend**: Flowë¡œ ì´ë²¤íŠ¸ ì „ë‹¬  
âœ… **awaitClose**: ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)  
âœ… **Lifecycle ì¸ì‹**: ViewModel ì¢…ë£Œ ì‹œ ìë™ ì†Œì¼“ í•´ì œ

#### 5. TokenAuthenticatorì˜ ìš°ì•„í•¨

**"OkHttp Authenticatorì˜ ì„¤ê³„ê°€ ì •ë§ ìš°ì•„í•˜ë‹¤ê³  ëŠê¼ˆìŠµë‹ˆë‹¤."**

**ì„¤ê³„ì˜ ì•„ë¦„ë‹¤ì›€: ì±…ì„ ë¶„ë¦¬**

```kotlin
// 1ï¸âƒ£ AuthInterceptor: ëª¨ë“  ìš”ì²­ì— í† í° ì¶”ê°€
class AuthInterceptor : Interceptor {
    override fun intercept(chain: Interceptor.Chain): Response {
        val token = tokenStorage.getAccessToken()
        val newRequest = chain.request().newBuilder()
            .addHeader("Authorization", "Bearer $token")
            .build()
        return chain.proceed(newRequest)
    }
}

// 2ï¸âƒ£ TokenAuthenticator: 401 ì—ëŸ¬ ì‹œì—ë§Œ ì‘ë™
class TokenAuthenticator : Authenticator {
    override fun authenticate(route: Route?, response: Response): Request? {
        // 401 ì—ëŸ¬ ë°œìƒ ì‹œì—ë§Œ í˜¸ì¶œë¨!
        val newToken = refreshToken()
        return response.request.newBuilder()
            .header("Authorization", "Bearer $newToken")
            .build()
    }
}
```

**í•µì‹¬ í¬ì¸íŠ¸**

âœ… **401 ì „ìš©**: ì¸ì¦ ì‹¤íŒ¨ ì‹œì—ë§Œ ìë™ í˜¸ì¶œ  
âœ… **ì¬ìš”ì²­ ìë™í™”**: ìƒˆ í† í°ìœ¼ë¡œ ì›ë˜ ìš”ì²­ ì¬ì‹œë„  
âœ… **ì‚¬ìš©ì ë¬´ê°ê°**: ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ íŠ•ê¸°ì§€ ì•ŠìŒ  
âœ… **ì¤‘ë³µ ë°©ì§€**: `X-Retry-Auth` í—¤ë”ë¡œ ë¬´í•œ ë£¨í”„ ì°¨ë‹¨

---

## âš ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. ìˆœí™˜ ì°¸ì¡° ë¬¸ì œ (TokenAuthenticator â†” RotateAccessTokenUseCase)

#### ë¬¸ì œ

```kotlin
// âŒ ìˆœí™˜ ì°¸ì¡° ë°œìƒ
class TokenAuthenticator @Inject constructor(
    private val rotateAccessTokenUseCase: RotateAccessTokenUseCase
) : Authenticator

class RotateAccessTokenUseCase @Inject constructor(
    private val authRepository: AuthRepository
)

class AuthRepositoryImpl @Inject constructor(
    private val authApi: AuthApi  // â† OkHttp í´ë¼ì´ì–¸íŠ¸ í•„ìš”
)

// OkHttp í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì‹œ TokenAuthenticator í•„ìš”
// â†’ ìˆœí™˜ ì°¸ì¡°!
```

#### í•´ê²°: Lazy ì£¼ì…

```kotlin
class TokenAuthenticator @Inject constructor(
    private val tokenStorage: TokenStorage,
    private val rotateAccessTokenUseCase: Lazy<RotateAccessTokenUseCase>  // â­ Lazy
) : Authenticator {

    override fun authenticate(route: Route?, response: Response): Request? {
        return runBlocking {
            val result = rotateAccessTokenUseCase.get().invoke()  // â­ get()ìœ¼ë¡œ ì§€ì—° í˜¸ì¶œ
            // ...
        }
    }
}
```

**í•µì‹¬**: `Lazy<T>`ëŠ” **ì‹¤ì œ ì‚¬ìš© ì‹œì ì— ì¸ìŠ¤í„´ìŠ¤ ìƒì„±**í•˜ì—¬ ìˆœí™˜ ì°¸ì¡° ë°©ì§€

---

### 2. EncryptedSharedPreferences ì´ˆê¸°í™” ì‹¤íŒ¨

#### ë¬¸ì œ

```
java.security.KeyStoreException: Failed to decrypt keys
```

ê¸°ê¸° ì¬ë¶€íŒ…, ì•± ì—…ë°ì´íŠ¸ ë“±ìœ¼ë¡œ **MasterKeyê°€ ì†ìƒ**ë˜ë©´ EncryptedSharedPreferences ì´ˆê¸°í™” ì‹¤íŒ¨

#### í•´ê²°: ì¬ì‹œë„ + Fallback ì „ëµ

```kotlin
private fun createEncryptedPreferences(): SharedPreferences {
    return runCatching {
        // 1ì°¨ ì‹œë„
        EncryptedSharedPreferences.create(...)
    }.recoverCatching {
        // 2ì°¨ ì‹œë„ (íŒŒì¼ ì •ë¦¬ í›„ ì¬ì‹œë„)
        deleteCorruptedFiles()
        EncryptedSharedPreferences.create(...)
    }.getOrElse {
        // Fallback: ì¼ë°˜ SharedPreferences
        context.getSharedPreferences("token_prefs_fallback", Context.MODE_PRIVATE)
    }
}
```

**í•µì‹¬**: **ë³´ì•ˆê³¼ ì•ˆì •ì„±ì˜ ê· í˜•**. ì•”í˜¸í™” ì‹¤íŒ¨í•´ë„ **ì•± í¬ë˜ì‹œëŠ” ë°©ì§€**.

---

### 3. Socket.IO Reconnection ì‹¤íŒ¨

#### ë¬¸ì œ

ì†Œì¼“ ì—°ê²°ì´ ëŠê¸´ í›„ **ìë™ ì¬ì—°ê²°ì´ ì•ˆ ë¨**.

#### í•´ê²°: `forceNew = true`

```kotlin
val options = IO.Options().apply {
    reconnection = true
    reconnectionAttempts = 5
    reconnectionDelay = 2000
    forceNew = true  // â­ ê¸°ì¡´ ì†Œì¼“ ì¬ì‚¬ìš© ì•ˆ í•¨
}
```

**í•µì‹¬**: **ê¸°ì¡´ ì†Œì¼“ ì¸ìŠ¤í„´ìŠ¤**ê°€ ë‚¨ì•„ìˆìœ¼ë©´ ì¬ì—°ê²° ì‹¤íŒ¨. `forceNew`ë¡œ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±.

---

### 4. Room + Retrofit ë™ê¸°í™” ë¬¸ì œ

#### ë¬¸ì œ

ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ì‚­ì œí–ˆëŠ”ë°, **ë¡œì»¬ DBì—ëŠ” ë‚¨ì•„ìˆì–´ì„œ UIì— ê³„ì† í‘œì‹œ**ë¨.

#### í•´ê²°: Remote First + Local Cache

```kotlin
override suspend fun findAllAnniversaries(): Result<List<Anniversary>> {
    return runCatching {
        // 1ï¸âƒ£ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ì¡°íšŒ
        val response = anniversaryApi.findAllAnniversaries()
        val anniversaries = response.body()!!.map { it.toDomain() }

        // 2ï¸âƒ£ ë¡œì»¬ DB ì „ì²´ ì‚­ì œ í›„ ì¬ì €ì¥
        anniversaryDao.deleteAll()
        anniversaryDao.insertAll(anniversaries.map { AnniversaryEntity.fromDomain(it) })

        anniversaries
    }.recoverCatching {
        // 3ï¸âƒ£ ì„œë²„ ì‹¤íŒ¨ ì‹œì—ë§Œ ë¡œì»¬ DB ì‚¬ìš©
        anniversaryDao.findAll().map { it.toDomain() }
    }
}
```

**í•µì‹¬**: **ì„œë²„ê°€ Single Source of Truth**. ë¡œì»¬ì€ ìºì‹œì¼ ë¿.

---

### 5. Compose Recomposition ì„±ëŠ¥ ì´ìŠˆ

#### ë¬¸ì œ

`List<Anniversary>`ë¥¼ `LazyColumn`ìœ¼ë¡œ í‘œì‹œí•  ë•Œ, **í•˜ë‚˜ë§Œ ìˆ˜ì •í•´ë„ ì „ì²´ ë¦¬ìŠ¤íŠ¸ê°€ Recomposition**ë¨.

#### í•´ê²°: `key` íŒŒë¼ë¯¸í„°

```kotlin
LazyColumn {
    items(
        items = anniversaries,
        key = { anniversary -> anniversary.id }  // â­ ê³ ìœ  í‚¤ ì§€ì •
    ) { anniversary ->
        AnniversaryCard(item = anniversary)
    }
}
```

**í•µì‹¬**: `key`ë¥¼ ì§€ì •í•˜ë©´ **ë³€ê²½ëœ ì•„ì´í…œë§Œ Recomposition**ë¨.

---
